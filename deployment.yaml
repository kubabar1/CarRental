apiVersion: v1
kind: ConfigMap
metadata:
  name: common-api-config
data:
  rabbitMqHost: "127.0.0.1"
  eurekaEnabled: "true"
  eurekaUri: "http://127.0.0.1:8761/eureka"
  frontendAppProtocol: "http"
  # important: set correct IP address (minikube ip)
  frontendAppHostname: "192.168.59.101"
  frontendAppPort: "30449"
  frontendAppContext: ""
  userServiceProtocol: "http"
  # important: set correct IP address (minikube ip)
  userServiceHostname: "192.168.59.101"
  userServicePort: "8080"
  userServiceContext: "/user-service"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
data:
  nginx.conf: |
    worker_processes 1;
    events { worker_connections 1024; }

    http {
      log_format upstream_logging '[$time_local] $remote_addr - $remote_user - $server_name: "$request" upstream_response_time $upstream_response_time msec $msec request_time $request_time';

      server {
           listen 80;

           proxy_set_header Host $host;
           proxy_set_header Origin $http_origin;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Server $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

           add_header Content-Type text/plain;
           add_header 'Access-Control-Allow-Origin' '$http_origin'  always;
           add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
           add_header 'Access-Control-Allow-Headers' 'Authorization, Cache-Control, Content-Type, credentials, X-XSRF-TOKEN, Accept, X-Requested-With' always;
           add_header 'Access-Control-Allow-Credentials' 'true' always;

           if ($request_method = OPTIONS ) {
               return 200;
           }

           proxy_hide_header 'access-control-allow-origin';
           proxy_hide_header 'access-control-allow-credentials';
           proxy_pass_request_headers      on;

           proxy_hide_header   Referer;
           proxy_hide_header   Origin;
           proxy_set_header    Referer           '';
           proxy_set_header    Origin            '';

           proxy_redirect off;
           proxy_set_header   Authorization "";

           location /auth-service/ {
              proxy_pass http://127.0.0.1:8081/;
           }

           location /user-service/ {
               proxy_pass http://127.0.0.1:8082/;
           }

           location /vehicle-service/ {
               proxy_pass http://127.0.0.1:8083/;
           }

           location /rating-service/ {
               proxy_pass http://127.0.0.1:8084/;
           }

           location /booking-service/ {
               proxy_pass http://127.0.0.1:8085/;
           }

           location /mail-service/ {
               proxy_pass http://127.0.0.1:8086/;
           }

           location /storage-service-stub/ {
               proxy_pass http://127.0.0.1:8087/;
           }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: demo
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: demo
    spec:
      containers:
      - image: nginx
        name: nginx
        resources: {}
        ports:
          - containerPort: 80
            name: "nginx-dpl"
          - containerPort: 5005
            name: "jvm-debug"
        volumeMounts:
          - name: nginx-conf
            mountPath: /etc/nginx/nginx.conf
            subPath: nginx.conf
            readOnly: true

      - image: rabbitmq:3-management-alpine
        name: rabbitmq
        resources: {}

      - image: eureka-server
        name: eureka-server
        imagePullPolicy: Never
        resources: {}

      - image: auth-service
        name: auth-service
        imagePullPolicy: Never
        resources: {}
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: FRONTEND_APP_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppProtocol
          - name: FRONTEND_APP_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppHostname
          - name: FRONTEND_APP_PORT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppPort
          - name: FRONTEND_APP_CONTEXT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppContext
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - image: user-service
        name: user-service
        imagePullPolicy: Never
        resources: { }
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: USER_SERVICE_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: userServiceProtocol
          - name: USER_SERVICE_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: userServiceHostname
          - name: USER_SERVICE_PORT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: userServicePort
          - name: USER_SERVICE_CONTEXT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: userServiceContext
          - name: FRONTEND_APP_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppProtocol
          - name: FRONTEND_APP_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppHostname
          - name: FRONTEND_APP_PORT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppPort
          - name: FRONTEND_APP_CONTEXT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppContext
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - image: vehicle-service
        name: vehicle-service
        imagePullPolicy: Never
        resources: {}
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: FRONTEND_APP_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppProtocol
          - name: FRONTEND_APP_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppHostname
          - name: FRONTEND_APP_PORT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppPort
          - name: FRONTEND_APP_CONTEXT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppContext
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - image: rating-service
        name: rating-service
        imagePullPolicy: Never
        resources: {}
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: FRONTEND_APP_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppProtocol
          - name: FRONTEND_APP_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppHostname
          - name: FRONTEND_APP_PORT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppPort
          - name: FRONTEND_APP_CONTEXT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppContext
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - image: booking-service
        name: booking-service
        imagePullPolicy: Never
        resources: {}
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: FRONTEND_APP_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppProtocol
          - name: FRONTEND_APP_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppHostname
          - name: FRONTEND_APP_PORT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppPort
          - name: FRONTEND_APP_CONTEXT
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: frontendAppContext
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - image: mail-service
        name: mail-service
        imagePullPolicy: Never
        resources: {}
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - image: storage-service-stub
        name: storage-service-stub
        imagePullPolicy: Never
        resources: {}
        env:
          - name: DEV
            value: "false"
          - name: RABBIT_HOST
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: rabbitMqHost
          - name: EUREKA_URI
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaUri
          - name: EUREKA_ENABLED
            valueFrom:
              configMapKeyRef:
                name: common-api-config
                key: eurekaEnabled

      - name: frontend-app
        image: frontend-app
        imagePullPolicy: Never
        resources: {}
      volumes:
        - name: nginx-conf
          configMap:
            name: nginx-conf
            items:
              - key: nginx.conf
                path: nginx.conf
status: {}
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  type: NodePort
  ports:
    - name: frontend-app
      port: 3030
      protocol: TCP
      targetPort: 3030
      nodePort: 30449
    - name: eureka-server
      port: 8761
      protocol: TCP
      targetPort: 8761
      nodePort: 32157
    - name: nginx-service
      port: 80
      protocol: TCP
      targetPort: 80
      nodePort: 30008
#    - name: vsl
#      port: 8083
#      protocol: TCP
#      targetPort: 8083
#      nodePort: 30009
#    - name: jvm-debug
#      port: 5005
#      protocol: TCP
#      targetPort: 5005
#      nodePort: 30010
  selector:
    app: demo
#---
#apiVersion: v1
#kind: Service
#metadata:
#  name: nginx-service
#  labels:
#    env: demo
#spec:
#  type: LoadBalancer
#  ports:
#    - port: 80
#  selector:
#    env: demo